@page "/transactions"
@using BankBlazor.Client.Services
@using BankBlazor.Shared.Models
@using BankBlazor.Shared.Dtos
@inject CustomerService CustomerService
@inject TransactionService TransactionService

<h1>Transaktioner</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}
@if (!string.IsNullOrEmpty(successMessage))
{
    <p class="text-success">@successMessage</p>
}

<EditForm Model="@transactionModel" OnValidSubmit="HandleValidSubmit" class="transaction-form">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="fromAccount">Från konto:</label>
        <InputSelect id="fromAccount" @bind-Value="transactionModel.FromAccountId" @onchange="OnFromAccountChanged" class="form-control">
            <option value="">-- Välj konto --</option>
            @foreach (var account in accounts)
            {
                <option value="@account.AccountId">@account.AccountId - Saldo: @account.Balance.ToString("C")</option>
            }
        </InputSelect>
    </div>

    <div class="form-group">
        <label for="transactionType">Transaktionstyp:</label>
        <InputSelect id="transactionType" @bind-Value="transactionModel.TransactionType" class="form-control">
            <option value="Deposit">Insättning</option>
            <option value="Withdraw">Uttag</option>
            <option value="Transfer">Överföring</option>
        </InputSelect>
    </div>

    @if (transactionModel.TransactionType == "Transfer")
    {
        <div class="form-group">
            <label for="toAccount">Till konto:</label>
            <InputSelect id="toAccount" @bind-Value="transactionModel.ToAccountId" class="form-control">
                <option value="">-- Välj mottagarkonto --</option>
                @foreach (var account in accounts)
                {
                    if (account.AccountId != transactionModel.FromAccountId)
                    {
                        <option value="@account.AccountId">@account.AccountId - Saldo: @account.Balance.ToString("C")</option>
                    }
                }
            </InputSelect>
        </div>
    }

    <div class="form-group">
        <label for="amount">Belopp:</label>
        <InputNumber id="amount" @bind-Value="transactionModel.Amount" class="form-control" />
    </div>

    <button type="submit" class="btn btn-primary">Genomför transaktion</button>
</EditForm>

@if (fromAccount != null)
{
    <p class="balance-info"><strong>Saldo för konto @fromAccount.AccountId:</strong> @fromAccount.Balance.ToString("C")</p>

    @if (transactions.Any())
    {
        <h3>Transaktionshistorik</h3>
        <table class="table table-striped transaction-table">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Typ</th>
                    <th>Belopp</th>
                    <th>Saldo efteråt</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var tx in transactions.OrderByDescending(t => t.Date))
                {
                    <tr>
                        <td>@tx.Date.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@tx.Type</td>
                        <td>@tx.Amount.ToString("C")</td>
                        <td>@tx.BalanceAfter.ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (transactionModel.TransactionType == "Transfer" && toAccount != null)
{
    <p class="balance-info"><strong>Saldo för mottagarkonto @toAccount.AccountId:</strong> @toAccount.Balance.ToString("C")</p>
}

@code {
    private List<Account> accounts = new();
    private List<TransactionDto> transactions = new();
    private string? errorMessage;
    private string? successMessage;

    private TransactionInputModel transactionModel = new();

    private Account? fromAccount => accounts.FirstOrDefault(a => a.AccountId == transactionModel.FromAccountId);
    private Account? toAccount => accounts.FirstOrDefault(a => a.AccountId == transactionModel.ToAccountId);

    protected override async Task OnInitializedAsync()
    {
        accounts = await CustomerService.GetAccountsAsync();
    }

    private async Task OnFromAccountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int accountId))
        {
            transactionModel.FromAccountId = accountId;
            await LoadTransactions(accountId);
        }
        else
        {
            transactions.Clear();
        }
    }

    private async Task LoadTransactions(int accountId)
    {
        transactions = await CustomerService.GetTransactionsAsync(accountId);
        StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        errorMessage = null;
        successMessage = null;

        if (transactionModel.Amount <= 0)
        {
            errorMessage = "Beloppet måste vara större än noll.";
            return;
        }

        if (transactionModel.TransactionType == "Transfer" && transactionModel.ToAccountId == 0)
        {
            errorMessage = "Du måste välja mottagarkonto vid överföring.";
            return;
        }

        try
        {
            bool result = transactionModel.TransactionType switch
            {
                "Deposit" => await TransactionService.DepositAsync(transactionModel.FromAccountId, transactionModel.Amount),
                "Withdraw" => await TransactionService.WithdrawAsync(transactionModel.FromAccountId, transactionModel.Amount),
                "Transfer" => await TransactionService.TransferAsync(transactionModel.FromAccountId, transactionModel.ToAccountId, transactionModel.Amount),
                _ => false
            };

            if (result)
            {
                successMessage = "Transaktionen genomfördes!";
                accounts = await CustomerService.GetAccountsAsync();
                await LoadTransactions(transactionModel.FromAccountId);
                transactionModel = new TransactionInputModel(); // Reset form
            }
            else
            {
                errorMessage = "Transaktionen misslyckades.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fel vid transaktion: {ex.Message}";
        }
    }

    private class TransactionInputModel
    {
        public int FromAccountId { get; set; }
        public int ToAccountId { get; set; }
        public decimal Amount { get; set; }
        public string TransactionType { get; set; } = "Deposit";
    }
}
